name: ðŸ”„ Scraper - Consultas PÃºblicas MME

on:
  schedule:
    - cron: "0 8 * * *" # Todos os dias Ã s 08:00 UTC
    - cron: "0 12 * * *" # TambÃ©m ao meio-dia
    - cron: "0 18 * * *" # E Ã s 18:00
  workflow_dispatch: # Permite execuÃ§Ã£o manual

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  scraper:
    name: ðŸ•·ï¸ Executar Scraper de Consultas
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Fazer checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ”„ Executar scraper
        run: |
          python scraper.py
        continue-on-error: true

      - name: ðŸ“Š Validar dados
        run: |
          if [ -f data/consultas.json ]; then
            echo "âœ“ Arquivo data/consultas.json criado"
            python -m json.tool data/consultas.json > /dev/null && echo "âœ“ JSON vÃ¡lido"
          else
            echo "âš  Arquivo nÃ£o criado - usando dados de exemplo"
          fi

      - name: ðŸ”” Verificar alertas (7 dias)
        run: |
          python -c "
          import json
          from datetime import datetime

          try:
            with open('data/consultas.json') as f:
              data = json.load(f)
            
            count = 0
            for c in data.get('consultas', []):
              if c.get('dias_restantes') == 7 and not c.get('notificado'):
                print(f\"ðŸ”” ALERTA: '{c['titulo'][:50]}' encerra em 7 dias!\")
                count += 1
            
            if count == 0:
              print('âœ“ Nenhuma consulta para alertar agora')
          except Exception as e:
            print(f'â„¹ VerificaÃ§Ã£o de alertas: {e}')
          "
        continue-on-error: true

      - name: ðŸ’¾ Commit de mudanÃ§as
        run: |
          git config user.name "ðŸ¤– Bot Consultas"
          git config user.email "bot@consultas-publicas.dev"

          if git diff --quiet data/consultas.json 2>/dev/null; then
            echo "â„¹ Sem alteraÃ§Ãµes nos dados"
          else
            echo "ðŸ“ AlteraÃ§Ãµes detectadas, commitando..."
            git add data/consultas.json
            git commit -m "ðŸ”„ chore: atualizar dados de consultas pÃºblicas"
            git push origin main 2>&1 || echo "Push jÃ¡ atualizado"
          fi

      - name: ðŸ“„ Deploy GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          force_orphan: false
        continue-on-error: true

  notify-status:
    name: ðŸ“§ Notificar Status (Opcional)
    runs-on: ubuntu-latest
    needs: scraper
    if: always()

    steps:
      - name: ðŸ“§ Enviar notificaÃ§Ã£o (desabilitada)
        run: |
          echo "NotificaÃ§Ã£o de status do scraper"
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "Status: Scraper executado"
          echo ""
          echo "ðŸ’¡ Para ativar notificaÃ§Ãµes WhatsApp:"
          echo "1. Configure secrets no GitHub:"
          echo "   - TWILIO_ACCOUNT_SID"
          echo "   - TWILIO_AUTH_TOKEN"
          echo "   - TWILIO_PHONE_NUMBER"
          echo "   - WHATSAPP_TARGETS"
          echo "2. Descomente a seÃ§Ã£o de notificaÃ§Ãµes em notifier.py"
