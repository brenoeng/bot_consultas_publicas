<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Consultas P√∫blicas - MME (Vers√£o Simplificada)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="min-h-screen">
      <!-- Header -->
      <header
        class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg"
      >
        <div class="max-w-7xl mx-auto px-4 py-8">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
              <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5z"
                />
              </svg>
              <h1 class="text-3xl font-bold">Consultas P√∫blicas</h1>
            </div>
            <button
              onclick="location.reload()"
              class="bg-blue-400 hover:bg-blue-300 px-4 py-2 rounded font-semibold transition"
            >
              üîÑ Atualizar
            </button>
          </div>
          <p class="text-blue-100">Minist√©rio de Minas e Energia (MME)</p>
        </div>
      </header>

      <!-- Main Content -->
      <main class="max-w-7xl mx-auto px-4 py-12">
        <!-- Instructions -->
        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6 rounded">
          <h3 class="font-bold text-yellow-900 mb-2">
            üìù Como usar esta p√°gina:
          </h3>
          <ol
            class="text-sm text-yellow-800 list-decimal list-inside space-y-1"
          >
            <li>
              Abra
              <code class="bg-yellow-100 px-1 rounded">scraper.html</code> para
              carregar dados
            </li>
            <li>Clique em "Carregar Dados de Teste"</li>
            <li>
              Salve o arquivo
              <code class="bg-yellow-100 px-1 rounded">consultas.json</code> em
              <code class="bg-yellow-100 px-1 rounded">data/</code>
            </li>
            <li>Abra este arquivo (index.html) no navegador</li>
            <li>A p√°gina carregar√° automaticamente os dados</li>
          </ol>
        </div>

        <!-- Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
          <div class="bg-white rounded-lg shadow p-6">
            <div class="text-3xl font-bold text-blue-600" id="totalCount">
              0
            </div>
            <p class="text-gray-600 text-sm mt-2">Total de Consultas</p>
          </div>
          <div class="bg-white rounded-lg shadow p-6">
            <div class="text-3xl font-bold text-yellow-600" id="proximosCount">
              0
            </div>
            <p class="text-gray-600 text-sm mt-2">Encerrando em 7 dias</p>
          </div>
          <div class="bg-white rounded-lg shadow p-6">
            <div class="text-3xl font-bold text-green-600" id="ativosCount">
              0
            </div>
            <p class="text-gray-600 text-sm mt-2">Consultas Ativas</p>
          </div>
        </div>

        <!-- Consultas Grid -->
        <div
          id="consultasContainer"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
        >
          <!-- Populated by JavaScript -->
        </div>

        <!-- Empty state -->
        <div id="emptyState" class="bg-white rounded-lg shadow p-8 text-center">
          <p class="text-gray-500 text-lg mb-2">Nenhuma consulta carregada</p>
          <p class="text-gray-400 text-sm">
            Abra
            <code class="bg-gray-100 px-2 py-1 rounded text-xs"
              >scraper.html</code
            >
            para adicionar dados
          </p>
        </div>

        <!-- Last Update -->
        <div class="text-center mt-12 text-gray-500 text-sm">
          <p id="lastUpdate">Aguardando dados...</p>
        </div>
      </main>

      <!-- Footer -->
      <footer class="bg-gray-800 text-gray-400 mt-12 py-6">
        <div class="max-w-7xl mx-auto px-4 text-center text-sm">
          <p>
            Bot de Monitoramento de Consultas P√∫blicas ‚Ä¢ Dados da
            <a
              href="https://consultas-publicas.mme.gov.br/home"
              class="text-blue-400 hover:underline"
              target="_blank"
              >Plataforma Oficial</a
            >
          </p>
        </div>
      </footer>
    </div>

    <script>
      // Dados de exemplo para teste
      const sampleData = {
        consultas: [
          {
            id: "consulta_001",
            titulo: "Consulta P√∫blica n¬∫ 42/2025 - Energias Renov√°veis",
            descricao:
              "Consulta sobre pol√≠ticas de incentivo a energias renov√°veis e sustent√°veis no Brasil.",
            data_abertura: "2025-11-20",
            data_encerramento: "2025-12-10",
            url_oficial: "https://consultas-publicas.mme.gov.br/home",
            dias_restantes: 14,
            notificado: false,
          },
          {
            id: "consulta_002",
            titulo: "Consulta P√∫blica n¬∫ 43/2025 - Efici√™ncia Energ√©tica",
            descricao:
              "Discuss√£o p√∫blica sobre programas de efici√™ncia energ√©tica industrial.",
            data_abertura: "2025-11-18",
            data_encerramento: "2025-12-03",
            url_oficial: "https://consultas-publicas.mme.gov.br/home",
            dias_restantes: 7,
            notificado: false,
          },
          {
            id: "consulta_003",
            titulo: "Consulta P√∫blica n¬∫ 44/2025 - Minera√ß√£o Sustent√°vel",
            descricao:
              "Regulamenta√ß√£o de pr√°ticas de minera√ß√£o com responsabilidade ambiental.",
            data_abertura: "2025-11-15",
            data_encerramento: "2025-12-01",
            url_oficial: "https://consultas-publicas.mme.gov.br/home",
            dias_restantes: 5,
            notificado: false,
          },
        ],
        ultimaAtualizacao: new Date().toISOString(),
      };

      let consultas = [];

      // Utility functions
      function calculateDaysRemaining(dataEncerramento) {
        if (!dataEncerramento) return null;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const [year, month, day] = dataEncerramento.split("-").map(Number);
        const encerramento = new Date(year, month - 1, day);
        const diffTime = encerramento - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
      }

      function formatDate(dateStr) {
        if (!dateStr) return "N/A";
        const [year, month, day] = dateStr.split("-");
        return `${day}/${month}/${year}`;
      }

      function getBadgeClass(diasRestantes) {
        if (diasRestantes === null) return "bg-gray-100 text-gray-800";
        if (diasRestantes > 7) return "bg-green-100 text-green-800";
        if (diasRestantes > 0) return "bg-yellow-100 text-yellow-800";
        return "bg-red-100 text-red-800";
      }

      function getBadgeText(diasRestantes) {
        if (diasRestantes === null) return "Data indeterminada";
        if (diasRestantes > 1) return `${diasRestantes} dias`;
        if (diasRestantes === 1) return "1 dia";
        if (diasRestantes === 0) return "Hoje";
        return "Encerrado";
      }

      function escapeHTML(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function sortConsultas(arr) {
        return arr.sort((a, b) => {
          const diasA = calculateDaysRemaining(a.data_encerramento) || Infinity;
          const diasB = calculateDaysRemaining(b.data_encerramento) || Infinity;
          return diasA - diasB;
        });
      }

      function renderConsulta(consulta) {
        const diasRestantes = calculateDaysRemaining(
          consulta.data_encerramento
        );
        const badgeClass = getBadgeClass(diasRestantes);
        const badgeText = getBadgeText(diasRestantes);
        const dataFormatada = formatDate(consulta.data_encerramento);

        return `
      <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow overflow-hidden">
        <div class="p-6">
          <div class="flex items-start justify-between mb-3">
            <h3 class="text-lg font-bold text-gray-800 flex-1 pr-3 line-clamp-2">
              ${escapeHTML(consulta.titulo)}
            </h3>
            <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full whitespace-nowrap ${badgeClass}">
              ${badgeText}
            </span>
          </div>
          
          ${
            consulta.descricao
              ? `<p class="text-gray-600 text-sm mb-4 line-clamp-3">${escapeHTML(
                  consulta.descricao
                )}</p>`
              : ""
          }
          
          <div class="border-t border-gray-200 pt-4 mb-4">
            <div class="flex items-center text-sm text-gray-600 mb-2">
              <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v2h16V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 011 1v1h1a1 1 0 110 2H7v1a1 1 0 11-2 0v-1H4a1 1 0 110-2h1V8a1 1 0 011-1z" clip-rule="evenodd"/>
              </svg>
              <strong>Encerramento:</strong>&nbsp;${dataFormatada}
            </div>
          </div>

          <a 
            href="${escapeHTML(consulta.url_oficial)}" 
            target="_blank" 
            rel="noopener noreferrer"
            class="inline-block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors"
          >
            Acessar Consulta
          </a>
        </div>
      </div>`;
      }

      function updateStats(consultasArray) {
        const total = consultasArray.length;
        const proximos = consultasArray.filter((c) => {
          const dias = calculateDaysRemaining(c.data_encerramento);
          return dias !== null && dias > 0 && dias <= 7;
        }).length;
        const ativos = consultasArray.filter((c) => {
          const dias = calculateDaysRemaining(c.data_encerramento);
          return dias !== null && dias > 0;
        }).length;

        document.getElementById("totalCount").textContent = total;
        document.getElementById("proximosCount").textContent = proximos;
        document.getElementById("ativosCount").textContent = ativos;
      }

      function renderPage(consultasArray) {
        const sorted = sortConsultas([...consultasArray]);
        const container = document.getElementById("consultasContainer");

        if (sorted.length === 0) {
          document.getElementById("emptyState").classList.remove("hidden");
          container.innerHTML = "";
        } else {
          document.getElementById("emptyState").classList.add("hidden");
          container.innerHTML = sorted.map(renderConsulta).join("\n");
        }

        updateStats(sorted);
        document.getElementById(
          "lastUpdate"
        ).textContent = `√öltima atualiza√ß√£o: ${new Date().toLocaleString(
          "pt-BR"
        )}`;
      }

      async function loadConsultas() {
        try {
          // Tentar carregar do arquivo JSON
          const response = await fetch("../data/consultas.json");

          if (response.ok) {
            const data = await response.json();
            consultas = data.consultas || [];
            renderPage(consultas);
          } else {
            // Se n√£o encontrar, mostrar dados de exemplo
            console.warn(
              "Arquivo data/consultas.json n√£o encontrado. Usando dados de exemplo."
            );
            consultas = sampleData.consultas;
            renderPage(consultas);
            document.getElementById("lastUpdate").textContent =
              "Usando dados de exemplo. Abra scraper.html para adicionar seus dados.";
          }
        } catch (error) {
          console.warn("Erro ao carregar dados:", error.message);
          // Fallback para dados de exemplo
          consultas = sampleData.consultas;
          renderPage(consultas);
          document.getElementById("lastUpdate").textContent =
            "Usando dados de exemplo. Abra scraper.html para adicionar seus dados.";
        }
      }

      // Load on page load
      document.addEventListener("DOMContentLoaded", loadConsultas);
    </script>
  </body>
</html>
